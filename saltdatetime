import { endOfMonth, endOfQuarter, subMonths, subQuarters, format, parseISO } from "date-fns";

const FMT = "yyyy-MM-dd";

// --- UTC helpers (no timezone drift) ---
const toUTC = (d: Date) => new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
const fromISO_UTC = (iso: string) => {
  const d = parseISO(iso); // local midnight
  return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); // force UTC midnight
};
const toISO = (d: Date) => format(d, FMT);

// --- Public API ---

/**
 * Latest *closed* month end as of "now" (UTC).
 * If today is before the end of this month, returns last month's end (CoB).
 * If today *is* the month end, returns today's month end.
 */
export const latestClosedMonthEndISO = (): string => {
  const now = new Date();
  const todayUTC = toUTC(now);
  const thisMonthEndUTC = endOfMonth(todayUTC);
  if (todayUTC < thisMonthEndUTC) {
    // month not closed yet → previous month's end
    return toISO(endOfMonth(subMonths(todayUTC, 1)));
  }
  // today is month end → closed today
  return toISO(thisMonthEndUTC);
};

/**
 * Given ANY ISO date (YYYY-MM-DD) — month-end or not —
 * return the **previous quarter's** CoB (YYYY-MM-DD).
 * e.g. "2025-06-30" → "2025-03-31", "2025-05-31" → "2025-03-31"
 */
export const previousQuarterEndFromISO = (iso: string): string => {
  const dUTC = fromISO_UTC(iso);
  return toISO(endOfQuarter(subQuarters(dUTC, 1)));
};